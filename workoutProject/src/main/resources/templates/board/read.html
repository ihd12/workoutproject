<!DOCTYPE HTML>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/basic.html}" xmlns:sec="http://www.w3.org/1999/xhtml">

<!-- Main Wrapper -->
<div layout:fragment="content" id="main-wrapper">
    <div class="wrapper style2">
        <div class="inner">
            <div class="container">
                <div id="content">


                    <div class="bodytext_area box_inner">
                        <header class="major">
                            <ul class="bbsview_list">
                                <li class="bbs_title"><h3>[[${board.title}]]</h3></li>
                                <li class="bbs_hit">작성자 : <span>[[${board.writer}]]</span></li>
                                <li class="bbs_hit">작성일 : <span>[[${#temporals.format(board.regDate, 'yyyy-MM-dd HH:mm')}]]</span>
                                </li>
<!--                                <li class="bbs_date" style="margin-bottom: 10px;">조회수 : <span>[[${board.view}]]</span>-->
                                </li>
                            </ul>
                        </header>

                        <!--                        <div class="editer_content" th:utext="${board.content}"></div>-->
                        <div th:each="fileName: ${board.fileNames}" style="margin-bottom: 20px;">
                            <img class="card-img-top"
                                 th:src="|/view/${fileName}|"
                                 style="max-width: 500px; height: auto; display: block;">
                        </div>
                        <div class="editer_content"
                             style="margin: 30px auto; max-width: 800px; text-align: center;"
                             th:utext="${board.content}">
                        </div>

                        <div style="margin: 50px 0;">
                            <hr style="margin: 0 0 5px 0; border: 0; border-top: 1px solid #ddd;">
                            <hr style="margin: 0; border: 0; border-top: 1px solid #ddd;">
                        </div>
                        <div class="btn_line">
                           <span sec:authorize="isAuthenticated()"
                                 th:if="${#authentication.principal.username == board.writer}">
                                 <a th:href="|@{/board/modify(bno=${board.bno})}&${link}|" class="btn-default"
                                  style="height: 2.2em; line-height: 2.2em; font-size: 0.9em; padding: 0 1em; display: inline-block; text-align: center;">수정</a>
                            </span>
                            <a href="/board/list" class="btn-default"
                               style="height: 2.2em; line-height: 2.2em; font-size: 0.9em; padding: 0 1em; display: inline-block; text-align: center;">목록</a>
                        </div>
                    </div>
                    <div style="margin: 50px 0;"></div>

                    <section>
                        <div class="card bg-light">
                            <div class="card-body">
                                <!-- Comment form-->
                                <div class="editer_content" style="margin-top: 30px;">
                                    <div style="display: flex; align-items: flex-start; gap: 10px;">
                                        <textarea class="replyText" style="flex: 1; height: 100px; resize: none;"
                                                  placeholder="댓글을 작성하세요"></textarea>
                                        <input type="button" value="등록" class="btn-default registerBtn"
                                               style="height: 100px; line-height: normal; font-size: 0.9em; padding: 0 1.5em; display: inline-block; text-align: center;">
                                    </div>
                                    <hr style="margin: 30px 0; border: 0; border-top: 1px solid #ddd;">
                                    <ul class="list-group replyList"></ul>
                                </div>
                            </div>
                        </div>
                    </section>

                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="/assets/js/reply.js"></script>
</div>

<script layout:fragment="script" th:inline="javascript">
    const bno = [[${board.bno}]];
    const currentUser = [[${#authentication.principal.username}]];  // 현재 로그인한 사용자

    const replyList = document.querySelector('.replyList');
    const registerBtn = document.querySelector(".registerBtn");
    const replyText = document.querySelector(".replyText");

    registerBtn.addEventListener("click", function (e) {
        if (replyText.value.trim() === '') {
            alert("댓글 내용을 입력해주세요");
            return;
        }

        const replyObj = {
            bno: bno,
            replyText: replyText.value,
            replyer: currentUser  // 현재 로그인한 사용자를 작성자로 설정
        }

        addReply(replyObj).then(result => {
            replyText.value = '';
            printReplies(1, 10, true);
        }).catch(e => {
            alert("댓글 등록에 실패했습니다");
            console.error(e);
        });
    });

    function printList(dtoList) {
        let str = '';
        if (dtoList && dtoList.length > 0) {
            for (const dto of dtoList) {
                str += `<li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <span class="fw-bold">${dto.replyer}</span>
                        <span class="ms-2">${dto.replyText}</span>
                    </div>
                    <div>
                        ${currentUser === dto.replyer ?
                    `<button class="btn-danger removeBtn" data-rno="${dto.rno}">삭제</button>`
                    : ''}
                    </div>
                </li>`;
            }
        } else {
            str = '<li class="list-group-item">등록된 댓글이 없습니다.</li>';
        }
        replyList.innerHTML = str;
    }

    function printReplies(page, size, goLast) {
        getList({bno, page, size, goLast}).then(
            data => {
                printList(data.dtoList);
            }
        ).catch(e => {
            console.error(e);
        });
    }

    // 초기 댓글 목록 로드
    printReplies(1, 10, true);

<<<<<<< HEAD
    replyList.addEventListener("click", function (e) {
        if (e.target.classList.contains('removeBtn')) {
=======
    // 댓글 삭제 이벤트
    replyList.addEventListener("click", function(e) {
        if(e.target.classList.contains('removeBtn')) {
>>>>>>> main
            const rno = e.target.getAttribute("data-rno");

            if (confirm('댓글을 삭제하시겠습니까?')) {
                removeReply(rno).then(result => {
                    alert('댓글이 삭제되었습니다.');
                    printReplies(1, 10, false);
                }).catch(e => {
                    alert('댓글 삭제에 실패했습니다.');
                    console.error(e);
                });
            }
        }
    });

</script>
</html>