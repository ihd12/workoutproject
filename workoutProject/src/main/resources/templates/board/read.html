<!DOCTYPE HTML>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/basic.html}">
<head th:fragment="head">
    <link rel="stylesheet" th:href="@{/assets/css/board/style.css}">
</head>

<div layout:fragment="content" id="main-wrapper">
    <div class="wrapper style2">
        <div class="inner">
            <div class="container">
                <div id="content">
<<<<<<< HEAD
                    <div class="post-header">
                        <h2 class="post-title" th:text="${board.title}">제목</h2>
                        <div class="post-info">
                            <span>작성자: <strong th:text="${board.writer}">작성자명</strong></span>
                            <span>작성일: <strong
                                    th:text="${#temporals.format(board.regDate, 'yyyy-MM-dd HH:mm')}">날짜</strong></span>
                            <span>조회수: <strong th:text="${board.view}">조회수</strong></span>
=======


                    <div class="bodytext_area box_inner">
                        <header class="major">
                            <ul class="bbsview_list">
                                <li class="bbs_title"><h3>[[${board.title}]]</h3></li>
                                <li class="bbs_hit">작성자 : <span>[[${board.writer}]]</span></li>
                                <li class="bbs_hit">작성일 : <span>[[${#temporals.format(board.regDate, 'yyyy-MM-dd HH:mm')}]]</span>
                            </ul>
                        </header>

                        <div th:each="fileName: ${board.fileNames}" style="margin-bottom: 20px;">
                            <img class="card-img-top"
                                 th:src="|/view/${fileName}|"
                                 style="max-width: 500px; height: auto; display: block;">
                        </div>
                        <div class="editer_content"
                             style="margin: 30px auto; max-width: 800px; text-align: center;"
                             th:utext="${board.content}">
                        </div>

                        <div style="margin: 50px 0;">
                            <hr style="margin: 0 0 5px 0; border: 0; border-top: 1px solid #ddd;">
                            <hr style="margin: 0; border: 0; border-top: 1px solid #ddd;">
                        </div>
                        <div class="btn_line">
                            <span sec:authorize="isAuthenticated()"
                                  th:if="${#authentication.principal.username == board.writer}"><a th:href="|@{/board/modify(bno=${board.bno})}&${link}|" class="btn-default"
                                  style="height: 2.2em; line-height: 2.2em; font-size: 0.9em; padding: 0 1em; display: inline-block; text-align: center;">수정</a>
                            </span>
                            <a href="/board/list" class="btn-default"
                               style="height: 2.2em; line-height: 2.2em; font-size: 0.9em; padding: 0 1em; display: inline-block; text-align: center;">목록</a>
>>>>>>> main
                        </div>
                    </div>

                    <div th:each="fileName: ${board.fileNames}" class="image-container">
                        <img th:src="|/view/${fileName}|"
                             alt="게시글 이미지"
                             class="post-image">
                    </div>
                    <div class="post-content" th:utext="${board.content}">
                    </div>

                    <div class="button-area">
                        <button class="button modify-button"
                                th:if="${#authentication.principal.username == board.writer}">수정
                        </button>
                        <button class="button list-button">목록</button>
                    </div>

                    <div class="comment-section">
                        <textarea class="comment-input" placeholder="댓글을 작성하세요"></textarea>
                        <button class="button comment-button">등록</button>
                    </div>

                </div>
                <div class="replyList"></div>
            </div>

        </div>
    </div>
</div>

<th:block layout:fragment="script">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="/assets/js/reply.js"></script>
    <script th:inline="javascript">

        document.addEventListener('DOMContentLoaded', function () {
            console.log('Script starting...');


            const bno = [[${board.bno}]];
            const currentUser = [[${#authentication.principal?.username}]];
            const isAdmin = [[${#authorization.expression('hasRole("ROLE_ADMIN")')}]];

            const replyList = document.querySelector('.replyList');
            const registerBtn = document.querySelector(".comment-button");
            const replyText = document.querySelector(".comment-input");
            console.log('Current User:', currentUser);


            function printList(dtoList) {
                let str = '';
                if (dtoList && dtoList.length > 0) {
                    for (const dto of dtoList) {
                        const date = new Date(dto.regDate);
                        const formattedDate = `${date.getFullYear()}년 ${date.getMonth() + 1}월 ${date.getDate()}일 ${date.getHours() > 12 ? '오후' : '오전'} ${String(date.getHours() % 12 || 12).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;

                        str += `
<div class="reply-item" data-rno="${dto.rno}">
    <div class="reply-header">
        <span class="reply-writer">${dto.replyer}</span>
        ${dto.flag ? `<span class="admin-tag">관리자</span>` : ''}
        <span class="reply-date">${formattedDate}</span>
    </div>
    <div class="reply-content">
        <div class="reply-text">${dto.replyText}</div>
    </div>
</div>`;
                    }
                } else {
                    str = '<div class="no-replies">등록된 댓글이 없습니다.</div>';
                }
                replyList.innerHTML = str;
            }


            // 버튼 이벤트 리스너 추가
            const modifyButton = document.querySelector('.modify-button');
            if (modifyButton) {
                modifyButton.addEventListener('click', function () {
                    window.location.href = `/board/modify?bno=${bno}`;
                });
            }

            const listButton = document.querySelector('.list-button');
            if (listButton) {
                listButton.addEventListener('click', function () {
                    window.location.href = '/board/list';
                });
            }

<<<<<<< HEAD
            function printReplies(page, size, goLast) {
                getList({bno, page, size, goLast}).then(
                    data => {
                        console.log('Replies data:', data);
                        printList(data.dtoList);
                    }
                ).catch(e => {
                    console.error('Error fetching replies:', e);
                });
            }
=======
    replyList.addEventListener("click", async function (e) {
        // 댓글 항목을 찾습니다
        const replyItem = e.target.closest('.reply-item');
        if (!replyItem) return;

        if (e.target.classList.contains('modifyBtn')) {
            const rno = replyItem.dataset.rno; // 이 부분이 중요합니다
            console.log('댓글 번호:', rno);  // 디버깅을 위한 로그 추가

            const replyContent = replyItem.querySelector('.reply-content');
            const replyText = replyContent.querySelector('.reply-text');
            const editArea = replyContent.querySelector('.edit-area');
            const buttonArea = replyContent.querySelector('.button-area');
            editArea.dataset.rno = rno;

            const textarea = editArea.querySelector('textarea');
            textarea.value = replyText.textContent.trim();
            textarea.focus();

            replyText.style.display = 'none';
            editArea.style.display = 'block';
            buttonArea.style.display = 'none';
>>>>>>> main


            console.log('Reply elements:', {replyList, registerBtn, replyText});

            // 댓글 등록 이벤트
            registerBtn.addEventListener("click", function (e) {
                if (replyText.value.trim() === '') {
                    alert("댓글 내용을 입력해주세요");
                    return;
                }

                const replyObj = {
                    bno: bno,
                    replyText: replyText.value,
                    replyer: currentUser,
                    flag : isAdmin
                }
                console.log(replyObj)

                addReply(replyObj).then(result => {
                    replyText.value = '';
                    printReplies(1, 10, true);
                }).catch(e => {
                    alert("댓글 등록에 실패했습니다");
                    console.error(e);
                });
            });


            // 댓글 목록 출력 함수


            // 댓글 수정/삭제 이벤트
            replyList.addEventListener("click", async function (e) {
                const replyItem = e.target.closest('.reply-item');
                if (!replyItem) return;

                if (e.target.classList.contains('modify-button')) {
                    const replyContent = replyItem.querySelector('.reply-content');
                    const replyText = replyContent.querySelector('.reply-text');
                    const editArea = replyContent.querySelector('.edit-area');
                    const buttonArea = replyItem.querySelector('.reply-buttons');

                    const textarea = editArea.querySelector('textarea');
                    textarea.value = replyText.textContent.trim();

                    replyText.style.display = 'none';
                    editArea.style.display = 'block';
                    buttonArea.style.display = 'none';
                }

                if (e.target.classList.contains('save-button')) {
                    const editArea = replyItem.querySelector('.edit-area');
                    const rno = replyItem.dataset.rno;
                    const textarea = editArea.querySelector('textarea');
                    const newText = textarea.value.trim();

                    if (!newText) return;

                    try {
                        await modifyReply({
                            rno: rno,
                            replyText: newText
                        });
                        printReplies(1, 10, false);
                    } catch (error) {
                        console.error('댓글 수정 실패:', error);
                        alert('댓글 수정에 실패했습니다.');
                    }
                }

                if (e.target.classList.contains('cancel-button')) {
                    const replyContent = replyItem.querySelector('.reply-content');
                    const replyText = replyContent.querySelector('.reply-text');
                    const editArea = replyContent.querySelector('.edit-area');
                    const buttonArea = replyItem.querySelector('.reply-buttons');

                    replyText.style.display = 'block';
                    editArea.style.display = 'none';
                    buttonArea.style.display = 'flex';
                }

                if (e.target.classList.contains('remove-button')) {
                    const rno = replyItem.dataset.rno;

                    if (confirm('댓글을 삭제하시겠습니까?')) {
                        try {
                            await removeReply(rno);
                            alert('댓글이 삭제되었습니다.');
                            printReplies(1, 10, false);
                        } catch (error) {
                            alert('댓글 삭제에 실패했습니다.');
                            console.error(error);
                        }
                    }
                }
            });

            // 초기 댓글 목록 로드
            printReplies(1, 10, true);
        });
    </script>
</th:block>
</html>